name: godot-ci

on:
  push:
    branches: [ main ]

env:
  EXPORT_NAME: endless-world
  GODOT_VERSION: 4.5.1

jobs:
  export-web:
    name: Web Export
    runs-on: ubuntu-latest
    # Don't use container - install Godot directly
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Godot 4.5.1
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_linux.x86_64.zip
          unzip Godot_v4.5.1-stable_linux.x86_64.zip
          chmod +x Godot_v4.5.1-stable_linux.x86_64
          sudo mv Godot_v4.5.1-stable_linux.x86_64 /usr/local/bin/godot
          godot --version

      - name: Download Export Templates
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz
          mkdir -v -p ~/.local/share/godot/export_templates/4.5.1.stable
          unzip Godot_v4.5.1-stable_export_templates.tpz
          mv templates/* ~/.local/share/godot/export_templates/4.5.1.stable/

      - name: Create .env file
        run: |
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" > .env
          echo "SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}" >> .env

      - name: Import project assets
        run: |
          godot --headless --verbose --editor --quit-after 2

      - name: Web Build
        run: |
          mkdir -v -p build/web
          godot --headless --verbose --export-release "Web" build/web/index.html

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web

      - name: Install Butler
        run: |
          wget https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default -O butler.zip
          unzip butler.zip
          chmod +x butler
          ./butler -V

      - name: Publish to itch.io
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          ./butler login
          ./butler push build/web endlessworlds/endless-world:html5

      - name: Notify Discord Channel
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@0.3.0
        with:
          args: 'An Endless World update is available at https://endlessworlds.itch.io/endless-world. ðŸŽ®'